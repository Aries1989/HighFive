# Adapted from various sources, including:
# - Louis Dionne's Hana: https://github.com/ldionne/hana
# - Paul Fultz II's FIT: https://github.com/pfultz2/Fit
# - Eric Niebler's range-v3: https://github.com/ericniebler/range-v3
# - Gabi Melman spdlog: https://github.com/gabime/spdlog

sudo: required
language: cpp

matrix:
  include:
    - env: USE_XTENSOR=True
      os: osx
      osx_image: xcode10.2

env:
  global:
    - MINCONDA_VERSION="latest"
    - MINCONDA_LINUX="Linux-x86_64"
    - MINCONDA_OSX="MacOSX-x86_64"

install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      MINCONDA_OS=$MINCONDA_LINUX;
    elif [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      HOMEBREW_NO_AUTO_UPDATE=1 brew install boost hdf5 eigen ninja;
      MINCONDA_OS=$MINCONDA_OSX;
    fi

  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      export CMAKE_GENERATOR="Visual Studio 15 2017 Win64" ;
      export TESTS_TARGET="RUN_TESTS";
      choco install --yes miniconda3 ;
      source C:/Tools/miniconda3/Scripts/activate ;
    else
      export CMAKE_GENERATOR="Ninja" ;
      export TESTS_TARGET="test";
      wget "http://repo.continuum.io/miniconda/Miniconda3-$MINCONDA_VERSION-$MINCONDA_OS.sh" -O miniconda.sh;
      bash miniconda.sh -b -p $HOME/miniconda ;
      source $HOME/miniconda/bin/activate;
      hash -r ;
    fi
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda install -c conda-forge xtl xsimd xtensor
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      conda install -c conda-forge boost hdf5 eigen;
    fi

before_script:
  - if [ -n "$GCC_VERSION" ]; then export CXX="g++-${GCC_VERSION}" CC="gcc-${GCC_VERSION}"; fi
  - if [ -n "$CLANG_VERSION" ]; then export CXX="clang++-${CLANG_VERSION}" CC="clang-${CLANG_VERSION}"; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export CXX="clang++" CC="clang"; fi
  - which $CXX
  - which $CC
  - $CXX --version
  - cmake --version

script:
  - cd ${TRAVIS_BUILD_DIR}
  - mkdir -p build && pushd build
  - >
    cmake --warn-uninitialized --debug-output
    -DUSE_EIGEN:BOOL=ON
    -DUSE_XTENSOR:BOOL=${USE_XTENSOR}
    -G "${CMAKE_GENERATOR}" ../
  - cmake --build .
  - CTEST_OUTPUT_ON_FAILURE=1 cmake --build . --target ${TESTS_TARGET}

 
